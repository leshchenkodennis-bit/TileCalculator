<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0f0f1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="–ü–ª–∏—Ç–∫–∞Calc">
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItCa0LDQu9GM0LrRg9C70Y/RgtC+0YAg0L/Qu9C40YLQvtGH0L3Ri9GFINC60L7QsdC+0YIiLAogICJzaG9ydF9uYW1lIjogItCf0LvQuNGC0LrQsENhbGMiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBmMGYxYSIsCiAgInRoZW1lX2NvbG9yIjogIiMwZjBmMWEiLAogICJpY29ucyI6IFt7CiAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCw8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnPjx0ZXh0IHk9Jy45ZW0nIGZvbnQtc2l6ZT0nOTAnPvCfk+A8L3RleHQ+PC9zdmc+IiwKICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgfV0KfQ==">
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–ª–∏—Ç–æ—á–Ω—ã—Ö —Ä–∞–±–æ—Ç</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìê</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" crossorigin="anonymous">
<style>
:root{--bg:#0f0f1a;--card:#1a1a2e;--accent:#f59e0b;--glow:rgba(245,158,11,.15);--text:#e2e8f0;--dim:#8b95a5;--border:#2a2a40;--ok:#10b981;--err:#ef4444;--surf:#16162a;--link:#60a5fa}
*{box-sizing:border-box;margin:0;padding:0}html,body{min-height:100vh;overflow-x:hidden}
body{background:radial-gradient(ellipse at top,#1a1a3e 0%,var(--bg) 60%);font-family:'Manrope','Segoe UI',system-ui,sans-serif;color:var(--text);padding:16px 14px 80px;-webkit-font-smoothing:antialiased}
::selection{background:var(--accent);color:var(--bg)}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield}
a{color:var(--link);text-decoration:none}a:hover{text-decoration:underline}
@keyframes fi{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.app{max-width:460px;margin:0 auto}
.prog{display:flex;gap:8px;margin-bottom:24px}.prog b{flex:1;height:4px;border-radius:4px;background:var(--border);transition:.4s}.prog b.on{background:linear-gradient(90deg,var(--accent),#fbbf24);box-shadow:0 0 8px var(--glow)}
.scr{display:none;animation:fi .35s ease}.scr.on{display:block}
.inp{width:100%;padding:13px 16px;background:var(--surf);border:1px solid var(--border);border-radius:11px;color:var(--text);font-size:15px;font-family:inherit;outline:none;transition:.25s}.inp:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
.inp-s{padding:7px 10px;background:var(--surf);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;font-family:inherit;outline:none;text-align:right;transition:.25s;width:80px}.inp-s:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
.bt{width:100%;padding:15px;border:none;border-radius:13px;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s}
.bt1{background:linear-gradient(135deg,var(--accent),#d97706);color:var(--bg)}.bt1:active{transform:scale(.98)}
.bt2{background:transparent;color:var(--dim);border:1px solid var(--border)}
.bt-s{width:auto;padding:7px 14px;border-radius:9px;font-size:12px;font-weight:600}
.sec{background:var(--card);border-radius:15px;border:1px solid var(--border);overflow:hidden;margin-bottom:14px}
.sec-h{padding:13px 18px;border-bottom:1px solid var(--border);font-weight:700;font-size:14px;display:flex;justify-content:space-between;align-items:center}
.sec-r{padding:12px 18px;border-bottom:1px solid var(--border);font-size:13px}.sec-r:last-child{border-bottom:none}
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(5px)}.mo.open{display:flex}
.mo-b{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:24px 22px;width:92%;max-width:420px;max-height:88vh;overflow-y:auto}
.tc{padding:26px 22px;background:linear-gradient(145deg,#2a1f0a,#1a1a2e);border:1px solid rgba(245,158,11,.3);border-radius:16px;text-align:center;margin-bottom:22px;position:relative;overflow:hidden}
.tc::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 0%,rgba(245,158,11,.12),transparent 70%);pointer-events:none}
.lnk{display:inline-flex;align-items:center;gap:4px;font-size:11px;margin-top:4px;padding:3px 9px;background:rgba(96,165,250,.08);border-radius:5px;border:1px solid rgba(96,165,250,.15);color:var(--link);transition:.2s;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.lnk:hover{background:rgba(96,165,250,.15)}
.spinner{width:14px;height:14px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin .7s linear infinite;display:inline-block}
.geo{padding:16px 20px;border-radius:13px;margin-bottom:22px;background:linear-gradient(135deg,var(--glow),transparent);border:1px solid rgba(245,158,11,.2)}
h1{font-size:24px;font-weight:800}
.hide{display:none!important}
.wi{padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:6px;transition:.2s}.wi.on{border-color:var(--accent);background:var(--glow)}
.ck{width:26px;height:26px;border-radius:7px;flex-shrink:0;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;transition:.2s;font-size:13px;font-weight:700;color:var(--bg)}
.wi.on .ck{border-color:var(--accent);background:var(--accent)}
.mi{padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:6px}.mi.on{border-color:var(--ok);background:rgba(16,185,129,.06)}
.mi .ck{border-color:var(--border)}.mi.on .ck{border-color:var(--ok);background:var(--ok)}
.ml{margin-top:6px;padding-left:36px;display:flex;flex-direction:column;gap:4px}
.ml-r{display:flex;align-items:center;gap:6px;font-size:11px;padding:5px 8px;background:rgba(96,165,250,.04);border:1px solid rgba(96,165,250,.1);border-radius:6px}
.ml-r a{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--link)}
.ml-r .p{color:var(--ok);font-weight:600;white-space:nowrap}
.ml-r .old{color:var(--dim);font-size:10px;text-decoration:line-through;white-space:nowrap}
.ml-r .x{background:none;border:none;color:var(--err);cursor:pointer;font-size:15px;padding:0 2px;line-height:1}
.ml-r .ed{background:none;border:none;color:var(--link);cursor:pointer;font-size:12px;padding:0 2px;line-height:1}
.ml-add{display:flex;flex-direction:column;gap:4px;margin-top:6px;padding:0 4px}
.ml-add input{width:100%;padding:7px 10px;background:var(--surf);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:12px;font-family:inherit;outline:none;box-sizing:border-box}
.ml-add input:focus{border-color:var(--link)}
.ml-add button{padding:6px 12px;border:none;border-radius:7px;background:var(--link);color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;flex-shrink:0}
.ml-add button:disabled{opacity:.5;cursor:wait}
.ml-add .ml-row{display:flex;gap:4px}

/* DB Panel */
.db-panel{background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:14px;overflow:hidden}
.db-header{padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);cursor:pointer}
.db-header h3{font-size:14px;font-weight:700;display:flex;align-items:center;gap:6px}
.db-body{padding:14px 16px}
.db-actions{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.db-btn{padding:7px 12px;border:1px solid var(--border);border-radius:8px;background:var(--surf);color:var(--text);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:4px;transition:.2s}
.db-btn:hover{border-color:var(--accent);background:var(--glow)}
.db-btn.danger{color:var(--err);border-color:rgba(239,68,68,.3)}
.db-btn.danger:hover{background:rgba(239,68,68,.08)}
.db-stat{font-size:11px;color:var(--dim);padding:8px 0}
.db-stat b{color:var(--accent)}

/* Price update badge */
.price-badge{display:inline-flex;align-items:center;gap:3px;font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600}
.price-badge.fresh{background:rgba(16,185,129,.12);color:var(--ok);border:1px solid rgba(16,185,129,.2)}
.price-badge.stale{background:rgba(245,158,11,.12);color:var(--accent);border:1px solid rgba(245,158,11,.2)}
.price-badge.old{background:rgba(239,68,68,.12);color:var(--err);border:1px solid rgba(239,68,68,.2)}

/* Refresh all button */
.refresh-all{display:flex;align-items:center;gap:6px;padding:10px 16px;background:linear-gradient(135deg,rgba(96,165,250,.1),rgba(96,165,250,.05));border:1px solid rgba(96,165,250,.2);border-radius:10px;margin-bottom:14px;cursor:pointer;transition:.2s;width:100%;font-family:inherit;color:var(--link);font-size:13px;font-weight:600}
.refresh-all:hover{background:rgba(96,165,250,.15);border-color:rgba(96,165,250,.3)}
.refresh-all:disabled{opacity:.5;cursor:wait}

/* History */
.hi-card{padding:12px 14px;background:var(--card);border:1px solid var(--border);border-radius:11px;margin-bottom:8px;cursor:pointer;transition:.2s}
.hi-card:hover{border-color:var(--accent);background:var(--glow)}
.hi-card .hi-title{font-weight:700;font-size:14px}
.hi-card .hi-sub{font-size:11px;color:var(--dim);margin-top:3px}
.hi-card .hi-price{color:var(--accent);font-weight:800;font-size:16px;margin-top:4px}
.hi-actions{display:flex;gap:6px;margin-top:6px}
.hi-actions button{padding:5px 10px;border-radius:7px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;border:1px solid var(--border);background:var(--surf);color:var(--text);transition:.2s}
.hi-actions button:hover{border-color:var(--accent)}
.hi-actions button.del{color:var(--err);border-color:rgba(239,68,68,.3)}
</style>
</head>
<body>
<div class="app">
<div class="prog"><b class="on" id="p1"></b><b id="p2"></b><b id="p3"></b></div>

<!-- STEP 1 -->
<div class="scr on" id="s1">
<div style="text-align:center;margin-bottom:28px"><div style="font-size:44px;margin-bottom:6px">üìê</div><h1>–û–±—ä—ë–º</h1><p style="color:var(--dim);margin-top:5px;font-size:13px">–†–∞–∑–º–µ—Ä—ã –ø–æ–º–µ—â–µ–Ω–∏—è</p></div>
<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:18px">
<input class="inp" type="number" id="iL" placeholder="–î–ª–∏–Ω–∞ (–º)" step="0.01">
<input class="inp" type="number" id="iW" placeholder="–®–∏—Ä–∏–Ω–∞ (–º)" step="0.01">
<input class="inp" type="number" id="iD" placeholder="–î–æ–ø. –≤—ã—á–∏—Ç–∞–Ω–∏–µ (–º¬≤)" step="0.01" value="0">
</div>
<div class="geo hide" id="geoBox"><div style="font-size:12px;color:var(--dim);margin-bottom:3px">–†–∞–±–æ—á–∞—è –ø–ª–æ—â–∞–¥—å</div><div style="font-size:30px;font-weight:800;color:var(--accent)" id="geoA"></div><div style="font-size:14px;color:var(--accent);margin-top:4px" id="geoCalc"></div><div style="font-size:11px;color:var(--dim);margin-top:3px" id="geoD"></div></div>
<button class="bt bt1" onclick="go(2)">–î–∞–ª–µ–µ ‚Üí</button>
<div style="display:flex;gap:9px;margin-top:14px">
<button class="bt bt2" style="flex:1;font-size:12px;padding:10px" onclick="exportAllData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
<button class="bt bt2" style="flex:1;font-size:12px;padding:10px" onclick="$('importAllFile').click()">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
<input type="file" id="importAllFile" accept=".json" style="display:none" onchange="importAllData(event)">
</div>
<div id="historyList" style="margin-top:20px"></div>
</div>

<!-- STEP 2 -->
<div class="scr" id="s2">
<div style="text-align:center;margin-bottom:24px"><div style="font-size:44px;margin-bottom:6px">üîß</div><h1>–†–∞–±–æ—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h1><p style="color:var(--dim);margin-top:5px;font-size:13px"><span style="color:var(--dim)">–ü–ª–æ—â–∞–¥—å:</span> <strong style="color:var(--accent)" id="s2a"></strong> <span style="color:var(--accent)">–º¬≤ √ó</span> <span style="color:var(--accent)" id="s2p"></span> <span style="color:var(--accent)">–≥—Ä–Ω =</span> <strong style="color:var(--accent)" id="s2t"></strong> <span style="color:var(--accent)">–≥—Ä–Ω</span></p></div>
<div id="workCards"></div>
<div id="matCards" style="margin-top:14px"></div>

<div style="display:flex;gap:9px;margin-top:18px">
<button class="bt bt2" style="flex:1" onclick="go(1)">‚Üê –ù–∞–∑–∞–¥</button>
<button class="bt bt1" style="flex:2" onclick="go(3)">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å ‚Üí</button>
</div>
</div>

<!-- STEP 3 -->
<div class="scr" id="s3">
<div style="text-align:center;margin-bottom:24px"><div style="font-size:44px;margin-bottom:6px">üí∞</div><h1>–ò—Ç–æ–≥</h1></div>
<div class="tc">
<div style="font-size:12px;color:var(--dim);margin-bottom:7px;position:relative">–°–¢–û–ò–ú–û–°–¢–¨ –†–ê–ë–û–¢</div>
<div style="font-size:40px;font-weight:800;color:var(--accent);position:relative;line-height:1.1" id="tWork"></div>
<div style="margin-top:14px;position:relative">
<div style="font-size:12px;color:var(--dim);margin-bottom:5px">–°–¢–û–ò–ú–û–°–¢–¨ –ú–ê–¢–ï–†–ò–ê–õ–û–í</div>
<div style="font-size:24px;font-weight:700;color:#fff" id="tMat"></div>
</div></div>

<!-- Refresh all button on results -->
<!-- Results content -->

<div class="sec"><div class="sec-h" style="background:rgba(245,158,11,.08);cursor:pointer;display:flex;align-items:center" onclick="toggleSec('wRows',this)"><span style="flex:1">üîß –†–∞–±–æ—Ç–∞ <span style="font-size:11px;font-weight:400;color:var(--dim)">‚ñ∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ</span></span><span style="color:var(--accent);margin-right:8px" id="whTotal"></span><button onclick="event.stopPropagation();exportPDF('works')" style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px 6px" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PDF">üìÑ</button></div><div id="wRows" style="display:none"></div></div>
<div class="sec"><div class="sec-h" style="background:rgba(16,185,129,.08);cursor:pointer;display:flex;align-items:center" onclick="toggleSec('mWrap',this)"><span style="flex:1">üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã <span style="font-size:11px;font-weight:400;color:var(--dim)">‚ñ∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ</span></span><span style="color:var(--ok);margin-right:8px" id="mhTotal"></span><button onclick="event.stopPropagation();exportPDF('mats')" style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px 6px" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å PDF">üìÑ</button></div><div id="mWrap" style="display:none"><div id="mRows"></div></div></div>

<div style="padding:12px 18px;background:var(--surf);border-radius:11px;font-size:12px;color:var(--dim);margin-bottom:18px;line-height:1.5" id="infoBar"></div>
<button class="bt bt2" style="margin-bottom:9px;font-size:14px;border-color:var(--accent);color:var(--accent)" onclick="saveToHistory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é</button>
<div style="display:flex;gap:9px">
<button class="bt bt2" style="flex:1" onclick="go(2)">‚Üê –ò–∑–º–µ–Ω–∏—Ç—å</button>
<button class="bt bt2" style="flex:1" onclick="resetAll()">üîÑ –°–±—Ä–æ—Å</button>
</div>
<button class="bt bt2" style="margin-top:9px;font-size:14px" onclick="openSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–Ω</button>
</div>
</div>

<!-- SETTINGS SCREEN -->
<div class="scr" id="s4">
<div style="text-align:center;margin-bottom:24px"><div style="font-size:44px;margin-bottom:6px">‚öôÔ∏è</div><h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–Ω</h1></div>

<div class="sec"><div class="sec-h" style="background:rgba(245,158,11,.08)"><span>üîß –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞</span></div>
<div style="padding:12px">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
<span style="font-size:13px;flex:1">–£–∫–ª–∞–¥–∫–∞ (–≥—Ä–Ω/–º¬≤)</span>
<input class="inp-s" type="number" id="setTilePrice" style="width:80px;font-size:14px;text-align:center">
</div>
<div style="display:flex;gap:8px;align-items:center">
<span style="font-size:13px;flex:1">–í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤ (–º)</span>
<input class="inp-s" type="number" id="setH" step="0.1" style="width:80px;font-size:14px;text-align:center">
</div>
</div></div>

<div class="sec"><div class="sec-h" style="background:rgba(245,158,11,.08)"><span>üîß –î–æ–ø. —Ä–∞–±–æ—Ç—ã</span></div>
<div id="setWorksList" style="padding:8px"></div></div>

<div class="sec"><div class="sec-h" style="background:rgba(16,185,129,.08)"><span>üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</span></div>
<div id="setMatsList" style="padding:8px"></div></div>

<div style="display:flex;gap:9px;margin-top:14px">
<button class="bt bt1" style="flex:1;font-size:14px" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button class="bt bt2" style="flex:1;font-size:14px" onclick="closeSettings()">‚Üê –ù–∞–∑–∞–¥</button>
</div>
</div>

<!-- WORK EDIT MODAL -->
<div class="mo" id="weMo" onclick="if(event.target===this)closeWorkEd()"><div class="mo-b">
<h3 style="margin-bottom:14px;font-size:17px;font-weight:700" id="weTitle"></h3>
<div style="display:flex;flex-direction:column;gap:9px;margin-bottom:14px">
<label style="font-size:12px;color:var(--dim)">–ù–∞–∑–≤–∞–Ω–∏–µ<input class="inp" id="weN" style="font-size:14px;margin-top:4px"></label>
<div style="display:flex;gap:8px"><label style="font-size:12px;color:var(--dim);flex:1">–¶–µ–Ω–∞ (–≥—Ä–Ω)<input class="inp" type="number" id="weP" step="1" style="font-size:14px;margin-top:4px"></label><label style="font-size:12px;color:var(--dim);flex:1">–ï–¥–∏–Ω–∏—Ü–∞<input class="inp" id="weU" style="font-size:14px;margin-top:4px"></label></div>
<label style="font-size:12px;color:var(--dim)">–†–∞—Å—á—ë—Ç –∫–æ–ª-–≤–∞<select class="inp" id="weT" style="font-size:14px;margin-top:4px;padding:12px 16px" onchange="weUpd()"><option value="area">–ü–æ –ø–ª–æ—â–∞–¥–∏</option><option value="manual">–í—Ä—É—á–Ω—É—é</option><option value="fixed">–§–∏–∫—Å. (1 —à—Ç)</option></select></label>
<label style="font-size:12px;color:var(--dim)" id="weQL">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ<input class="inp" type="number" id="weQ" step="0.1" style="font-size:14px;margin-top:4px"></label>
<div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surf);border-radius:9px;border:1px solid var(--border)"><input type="checkbox" id="weDed" style="width:18px;height:18px;accent-color:var(--accent)" onchange="weUpd()"><label for="weDed" style="font-size:12px;color:var(--dim);flex:1">–í—ã—á–∏—Ç–∞—Ç—å –∏–∑ –ø–ª–æ—â–∞–¥–∏</label><input class="inp-s" type="number" id="weDedV" step="0.1" value="1" style="width:60px;font-size:12px"></div>
</div>
<div style="display:flex;gap:9px"><button class="bt bt2" style="flex:1;padding:11px;font-size:13px" onclick="closeWorkEd()">–û—Ç–º–µ–Ω–∞</button><button class="bt bt1" style="flex:1;padding:11px;font-size:13px" onclick="saveWorkEd()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
</div></div>

<!-- MAT ADD MODAL (only for new materials) -->
<div class="mo" id="meMo" onclick="if(event.target===this)closeMatEd()"><div class="mo-b">
<h3 style="margin-bottom:14px;font-size:17px;font-weight:700" id="meTitle">–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª</h3>
<div style="display:flex;flex-direction:column;gap:9px;margin-bottom:14px">
<label style="font-size:12px;color:var(--dim)">–ù–∞–∑–≤–∞–Ω–∏–µ<input class="inp" id="meN" style="font-size:14px;margin-top:4px"></label>
<div style="display:flex;gap:8px">
<label style="font-size:12px;color:var(--dim);flex:1">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (–≥—Ä–Ω)<input class="inp" type="number" id="meP" step="1" style="font-size:14px;margin-top:4px"></label>
<label style="font-size:12px;color:var(--dim);flex:1">–ï–¥–∏–Ω–∏—Ü–∞<input class="inp" id="meU" style="font-size:14px;margin-top:4px"></label>
</div>
<label style="font-size:12px;color:var(--dim)">–†–∞—Å—Ö–æ–¥ –Ω–∞ 1 –º¬≤ <span style="font-size:10px">(0 = —Ñ–∏–∫—Å.)</span><input class="inp" type="number" id="meR" step="0.001" style="font-size:14px;margin-top:4px"></label>
<label style="font-size:12px;color:var(--dim)" id="meFQWrap">–§–∏–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ <span style="font-size:10px">(–µ—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥=0)</span><input class="inp" type="number" id="meFQ" step="1" style="font-size:14px;margin-top:4px"></label>
</div>
<div style="display:flex;gap:9px"><button class="bt bt2" style="flex:1;padding:11px;font-size:13px" onclick="closeMatEd()">–û—Ç–º–µ–Ω–∞</button><button class="bt bt1" style="flex:1;padding:11px;font-size:13px" onclick="saveMatEd()">–î–æ–±–∞–≤–∏—Ç—å</button></div>
</div></div>

<!-- LINK EDIT MODAL -->
<div class="mo" id="leMo" onclick="if(event.target===this)closeLinkEd()"><div class="mo-b">
<h3 style="margin-bottom:14px;font-size:17px;font-weight:700">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</h3>
<div style="display:flex;flex-direction:column;gap:9px;margin-bottom:14px">
<label style="font-size:12px;color:var(--dim)">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞<input class="inp" id="leTitle" placeholder="–Ω–∞–ø—Ä. Ceresit CM 11 25–∫–≥" style="font-size:13px;margin-top:4px"></label>
<label style="font-size:12px;color:var(--dim)">URL<input class="inp" id="leUrl" style="font-size:13px;margin-top:4px"></label>
<label style="font-size:12px;color:var(--dim)">–¶–µ–Ω–∞ (–≥—Ä–Ω)<input class="inp" type="number" id="lePrice" step="1" style="font-size:14px;margin-top:4px"></label>
<label style="font-size:12px;color:var(--dim)">–ó–∞–º–µ—Ç–∫–∞<input class="inp" id="leNote" placeholder="–Ω–∞–ø—Ä. –≠–ø–∏—Ü–µ–Ω—Ç—Ä, –∞–∫—Ü–∏—è –¥–æ 01.03" style="font-size:13px;margin-top:4px"></label>
<div style="display:flex;gap:8px;align-items:center">
<button class="db-btn" onclick="window.open($('leUrl').value,'_blank')" style="flex:1">üîó –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É</button>
<div style="font-size:10px;color:var(--dim);flex:1">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ü–µ–Ω—É –Ω–∞ —Å–∞–π—Ç–µ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ</div>
</div>
</div>
<div style="display:flex;gap:9px"><button class="bt bt2" style="flex:1;padding:11px;font-size:13px" onclick="closeLinkEd()">–û—Ç–º–µ–Ω–∞</button><button class="bt bt1" style="flex:1;padding:11px;font-size:13px" onclick="saveLinkEd()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
</div></div>

<script>
// One-time reset to clear corrupted data from previous versions
if(!localStorage.getItem("tilecalc_v4_clean")){
  for(var k in localStorage){if(k.indexOf("tilecalc")===0)localStorage.removeItem(k);}
  localStorage.setItem("tilecalc_v4_clean","1");
}
var H=2.7,DA=1.47;
var TILE_WORK={id:"tile",name:"–û–±–ª–∏—Ü–æ–≤–∫–∞",price:670,unit:"–º¬≤"};
const BASE_WORKS=[
  {id:"groutCement",name:"–ó–∞—Ç–∏—Ä–∫–∞ —Ü–µ–º–µ–Ω—Ç–Ω–∞—è",price:100,unit:"–º¬≤",type:"area",enabled:false,group:"grout"},
  {id:"groutEpoxy",name:"–ó–∞—Ç–∏—Ä–∫–∞ —ç–ø–æ–∫—Å–∏–¥–Ω–∞—è",price:150,unit:"–º¬≤",type:"area",enabled:false,group:"grout"},
  {id:"seal",name:"–ì–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏—è",price:50,unit:"–º.–ø.",type:"manual",qty:0,enabled:false},
  {id:"cut",name:"–ß–∏—Å—Ç—ã–π —Ä–µ–∑",price:100,unit:"–º.–ø.",type:"manual",qty:0,enabled:false},
  {id:"holes",name:"–û—Ç–≤–µ—Ä—Å—Ç–∏—è",price:150,unit:"—à—Ç",type:"manual",qty:0,enabled:false},
  {id:"tray",name:"–ü–æ–¥–¥–æ–Ω 90√ó90",price:7000,unit:"—à—Ç",type:"fixed",enabled:false,deduct:1},
  {id:"install",name:"–ò–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è",price:3500,unit:"—à—Ç",type:"fixed",enabled:false,deduct:1},
];
const BASE_MATS=[
  // ‚ïê‚ïê –û–±–ª–∏—Ü–æ–≤–∫–∞ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã, –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–ª–æ—â–∞–¥–∏) ‚ïê‚ïê
  {id:"adhesive",name:"–¶–µ–º–µ–Ω—Ç–Ω—ã–π –ø–ª–∏—Ç–æ—á–Ω—ã–π –∫–ª–µ–π",unit:"–º–µ—à–æ–∫ 25–∫–≥",rate:0,price:0,enabled:true,links:[],rateKg:1.3,layerMm:3}, // —Å–ø–µ—Ü. —Ä–∞—Å—á—ë—Ç: rateKg√ólayerMm√óarea/25
  {id:"primer",name:"–ì—Ä—É–Ω—Ç–æ–≤–∫–∞ –≥–ª—É–±–æ–∫–æ–≥–æ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è",unit:"–ª",rate:0.15,price:0,enabled:true,links:[]}, // 150–≥=0.15–∫–≥‚âà0.15–ª /–º¬≤
  {id:"svpBase",name:"–°–í–ü –æ—Å–Ω–æ–≤—ã (500 —à—Ç/—É–ø)",unit:"—É–ø.",rate:0,price:0,enabled:true,links:[],fixedQty:2},
  {id:"svpWedge",name:"–°–í–ü –∫–ª–∏–Ω—å—è (250 —à—Ç/—É–ø)",unit:"—É–ø.",rate:0,price:0,enabled:true,links:[],fixedQty:2},
  // ‚ïê‚ïê –ó–∞—Ç–∏—Ä–∫–∞ ‚Äî –≤—ã–±–æ—Ä –æ–¥–Ω–æ–π –∏–∑ –¥–≤—É—Ö (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ä–∞–±–æ—Ç–µ) ‚ïê‚ïê
  {id:"groutCement",name:"–ó–∞—Ç–∏—Ä–∫–∞ —Ü–µ–º–µ–Ω—Ç–Ω–∞—è",unit:"–∫–≥",rate:0.06,price:0,enabled:true,links:[],cond:"groutCement"},
  {id:"groutEpoxy",name:"–ó–∞—Ç–∏—Ä–∫–∞ —ç–ø–æ–∫—Å–∏–¥–Ω–∞—è",unit:"–∫–≥",rate:0.06,price:0,enabled:true,links:[],cond:"groutEpoxy"},
  // ‚ïê‚ïê –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏ –æ–±–ª–∏—Ü–æ–≤–∫–∏ (—Ñ–∏–∫—Å) ‚ïê‚ïê
  {id:"epoxyRemover",name:"–°—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç–ø–æ–∫—Å–∏–¥–Ω–æ–≥–æ –Ω–∞–ª—ë—Ç–∞",unit:"–±—É—Ç—ã–ª–∫–∞",rate:0,price:0,enabled:true,links:[],fixedQty:1},
  {id:"spongeCellulose",name:"–¶–µ–ª–ª—é–ª–æ–∑–Ω–∞—è –≥—É–±–∫–∞",unit:"—à—Ç",rate:0,price:0,enabled:true,links:[],fixedQty:1},
  {id:"spongeAbrasive",name:"–ê–±—Ä–∞–∑–∏–≤–Ω–∞—è –≥—É–±–∫–∞",unit:"—à—Ç",rate:0,price:0,enabled:true,links:[],fixedQty:1},
  {id:"masktape",name:"–ú–∞–ª—è—Ä–Ω—ã–π —Å–∫–æ—Ç—á (50–º)",unit:"—à—Ç",rate:0,price:0,enabled:true,links:[],fixedQty:1},
  {id:"blades",name:"–õ–µ–∑–≤–∏—è –º–∞–ª—è—Ä–Ω—ã–µ",unit:"—É–ø.",rate:0,price:0,enabled:true,links:[],fixedQty:1},
  {id:"ductTape",name:"–°–∫–æ—Ç—á –∞—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (30–º)",unit:"—à—Ç",rate:0,price:0,enabled:true,links:[],fixedQty:1},
  // ‚ïê‚ïê –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ä–∞–±–æ—Ç–µ "–ì–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏—è" ‚ïê‚ïê
  {id:"silicone",name:"–°–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π —Å–∏–ª–∏–∫–æ–Ω",unit:"–±–∞–ª–ª–æ–Ω",rate:0,price:0,enabled:true,links:[],fixedQty:2,cond:"seal"},
  // ‚ïê‚ïê –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ä–∞–±–æ—Ç–µ "–ü–æ–¥–¥–æ–Ω" ‚ïê‚ïê
  {id:"hydro",name:"–û–±–º–∞–∑–æ—á–Ω–∞—è –≥–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è (7–∫–≥)",unit:"–≤–µ–¥—Ä–æ",rate:0,price:0,enabled:true,links:[],fixedQty:1,cond:"tray"},
  {id:"hydroTape",name:"–ì–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞ (10–º)",unit:"—à—Ç",rate:0,price:0,enabled:true,links:[],fixedQty:1,cond:"tray"},
];

let S;
const $=id=>document.getElementById(id);
const r1=n=>Math.round(n*10)/10;
const fmt=n=>n.toLocaleString("uk-UA");
const esc=s=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
const now=()=>Date.now();

function defaultState(){return{works:JSON.parse(JSON.stringify(BASE_WORKS)),materials:JSON.parse(JSON.stringify(BASE_MATS))};}

const STORAGE_KEY="tilecalc_data";
const BACKUP_KEY="tilecalc_backup";

function loadState(){
  try{
    // 1. Try permanent key
    let s=localStorage.getItem(STORAGE_KEY);
    // 2. Migrate from any old versioned key
    if(!s){
      for(let v=50;v>=9;v--){
        s=localStorage.getItem("tilecalc_v"+v);
        if(s)break;
      }
    }
    // 3. Try backup
    if(!s)s=localStorage.getItem(BACKUP_KEY);

    if(s){
      S=JSON.parse(s);
      if(!S.works)S.works=JSON.parse(JSON.stringify(BASE_WORKS));
      S.works=S.works.filter(w=>w.id!=="tile");
      if(!S.materials)S.materials=JSON.parse(JSON.stringify(BASE_MATS));
      S.materials.forEach(m=>{
        if(!m.links)m.links=[];
        if(m.enabled===undefined)m.enabled=true;
        // Migrate: sync price and title from links if not set
        if((!m.price||m.price===0)&&m.links.length>0){
          const lp=m.links.filter(l=>l.price>0);
          if(lp.length>0)m.price=Math.min.apply(null,lp.map(l=>l.price));
        }
        if(!m.productTitle&&m.links.length>0){
          for(var li=0;li<m.links.length;li++){
            if(m.links[li].title){m.productTitle=m.links[li].title;break;}
          }
        }
        m.links.forEach(l=>{
          if(!l.updated)l.updated=now();
          if(!l.note)l.note="";
          if(!l.title)l.title="";
          if(!l.history)l.history=[];
        });
      });
      // Save to permanent key immediately
      if(S._tilePrice)TILE_WORK.price=S._tilePrice;
      if(S._H)H=S._H;
      saveState();
      return;
    }
  }catch(e){}
  S=defaultState();
}

function saveState(){
  try{
    const d=JSON.stringify(S);
    localStorage.setItem(STORAGE_KEY,d);
    localStorage.setItem(BACKUP_KEY,d);
  }catch(e){}
}

// ‚ïê‚ïê‚ïê LINK HELPERS ‚ïê‚ïê‚ïê
function matPrice(m){
  // Direct price field is the source of truth
  if(m.price>0)return m.price;
  // Fallback: check links for backward compatibility
  const p=(m.links||[]).filter(l=>l.price>0);
  return p.length?Math.min.apply(null,p.map(l=>l.price)):0;
}
function matBest(m){
  const p=(m.links||[]).filter(l=>l.price>0);
  if(!p.length)return null;
  let b=p[0];p.forEach(l=>{if(l.price<b.price)b=l;});
  return b;
}
function matQty(m,area){
  // –°–ø–µ—Ü. —Ä–∞—Å—á—ë—Ç –∫–ª–µ—è: rateKg (–∫–≥/–º¬≤/–º–º) √ó layerMm √ó area / 25–∫–≥ = –º–µ—à–∫–∏
  if(m.rateKg&&m.layerMm)return Math.ceil(m.rateKg*m.layerMm*area/25);
  if(m.fixedQty)return m.fixedQty;
  if(m.rate>0)return Math.ceil(area*m.rate);
  return 0;
}
function eIds(){return new Set(S.works.filter(w=>w.enabled).map(w=>w.id));}

function hostName(url){try{return new URL(url).hostname.replace("www.","");}catch(e){return"—Å—Å—ã–ª–∫–∞";}}

function priceAge(updated){
  if(!updated)return{cls:"old",text:"–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"};
  const diff=now()-updated;
  const days=Math.floor(diff/86400000);
  if(days<1)return{cls:"fresh",text:"—Å–µ–≥–æ–¥–Ω—è"};
  if(days<3)return{cls:"fresh",text:days+"–¥ –Ω–∞–∑–∞–¥"};
  if(days<7)return{cls:"stale",text:days+"–¥ –Ω–∞–∑–∞–¥"};
  return{cls:"old",text:days+"–¥ –Ω–∞–∑–∞–¥"};
}

function totalLinks(){
  let count=0,withPrice=0;
  S.materials.forEach(m=>(m.links||[]).forEach(l=>{count++;if(l.price>0)withPrice++;}));
  return{count,withPrice};
}

// ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê
function go(n){
  try{
    document.querySelectorAll(".scr").forEach(function(s){s.classList.remove("on")});
    $("s"+n).classList.add("on");
    for(var i=1;i<=3;i++)$("p"+i).classList.toggle("on",i<=n);
    window.scrollTo(0,0);
    if(n===1){S.works.forEach(function(w){w.enabled=false});saveState();renderHistory();}
    if(n===2){var w=calcW();$("s2a").textContent=w;$("s2p").textContent=TILE_WORK.price;$("s2t").textContent=fmt(Math.round(w*TILE_WORK.price));renderWC();renderMC();updateDbPanel();}
    if(n===3){renderResult();}
  }catch(e){console.error("go error:",e);}
}

// ‚ïê‚ïê‚ïê CALC ‚ïê‚ïê‚ïê
function gv(){return{l:parseFloat($("iL").value)||0,w:parseFloat($("iW").value)||0,d:parseFloat($("iD").value)||0}}
function calcW(){const{l,w,d}=gv();let b=Math.max(l*w+(l+w)*2*H-DA-d,0);let r=0;S.works.forEach(w=>{if(w.enabled&&w.deduct)r+=w.deduct;});return r1(Math.max(b-r,0));}
function updGeo(){const{l,w}=gv(),fl=l*w,wa=(l+w)*2*H,wk=calcW();if(wk>0){$("geoBox").classList.remove("hide");$("geoA").textContent=wk+" –º¬≤";$("geoCalc").textContent=wk+" √ó "+TILE_WORK.price+" –≥—Ä–Ω = "+fmt(Math.round(wk*TILE_WORK.price))+" –≥—Ä–Ω";$("geoD").textContent=`–ü–æ–ª: ${r1(fl)} ¬∑ –°—Ç–µ–Ω—ã: ${r1(wa)} ¬∑ –î–≤–µ—Ä—å: ‚àí${DA} –º¬≤`;}else $("geoBox").classList.add("hide");}

// ‚ïê‚ïê‚ïê WORK CARDS ‚ïê‚ïê‚ïê
let showWorkList=false;
function wQty(w,a){return w.type==="area"?a:w.type==="fixed"?1:w.qty||0;}
function renderWC(){
  const a=calcW();

  // Summary for collapsed view
  let workCount=0,workTotal=0;
  S.works.forEach(w=>{if(!w.enabled)return;const q=wQty(w,a);workCount++;workTotal+=Math.round(q*w.price);});

  let h='<div style="margin-bottom:8px;font-weight:700;font-size:15px;display:flex;justify-content:space-between;align-items:center">';
  if(workCount>0)h+=`<span style="font-size:13px;font-weight:600;color:var(--accent)">${workCount} –ø–æ–∑. ¬∑ ${fmt(workTotal)} –≥—Ä–Ω</span>`;
  h+=`</div>`;

  const wArrow=showWorkList?"‚ñ≤":"‚ñº";
  h+=`<button class="bt bt2" style="padding:14px;font-size:15px;font-weight:800;border:2px solid var(--accent);color:var(--accent);background:rgba(245,158,11,.08)" onclick="showWorkList=!showWorkList;renderWC()">üîß –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã ${wArrow}</button>`;

  if(showWorkList){
  S.works.forEach((w,i)=>{
    const on=w.enabled,q=wQty(w,a),s=on?Math.round(q*w.price):0;
    h+=`<div class="wi${on?" on":""}"><div style="display:flex;align-items:center;gap:10px"><div class="ck" style="cursor:pointer" onclick="toggleW(${i})">${on?"‚úì":""}</div><div style="flex:1;min-width:0;cursor:pointer" onclick="toggleW(${i})"><div style="font-weight:600;font-size:14px">${esc(w.name)}${w.title?' <span style="color:var(--accent);font-size:12px;font-weight:500">'+esc(w.title)+'</span>':""}</div><div style="font-size:11px;color:var(--dim);margin-top:2px">${w.price} –≥—Ä–Ω/${esc(w.unit)}${on&&q>0?" ¬∑ "+q+" "+esc(w.unit)+" = "+fmt(s)+" –≥—Ä–Ω":""}${w.deduct?" ¬∑ ‚àí"+w.deduct+" –º¬≤":""}</div></div><button onclick="openWorkEd(${i})" style="background:none;border:none;cursor:pointer;font-size:15px;padding:4px;color:var(--dim)">‚úèÔ∏è</button>${!BASE_WORKS.find(bw=>bw.id===w.id)?`<button onclick="S.works.splice(${i},1);saveState();renderWC();renderMC()" style="background:none;border:none;cursor:pointer;font-size:13px;padding:4px;color:var(--err)">‚úï</button>`:""}</div>`;
    if(on&&w.type==="manual")h+=`<div style="margin-top:6px;display:flex;align-items:center;gap:8px;padding-left:36px"><span style="font-size:11px;color:var(--dim)">–ö–æ–ª-–≤–æ:</span><input class="inp-s" type="number" step="0.1" value="${w.qty||""}" style="width:70px;font-size:13px" onchange="S.works[${i}].qty=parseFloat(this.value)||0;saveState();renderWC()"><span style="font-size:11px;color:var(--dim)">${esc(w.unit)}</span></div>`;
    h+=`</div>`;
    h+=`</div>`;
  });
  h+=`<button class="bt bt2" style="padding:12px;font-size:14px;margin-top:4px" onclick="openWorkEd(-1)">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>`;
  h+=`<button class="bt bt2" style="padding:12px;font-size:14px;margin-top:4px" onclick="showWorkList=false;renderWC()">‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å —Ä–∞–±–æ—Ç—ã</button>`;
  }

  $("workCards").innerHTML=h;
  const ww=calcW();$("s2a").textContent=ww;$("s2p").textContent=TILE_WORK.price;$("s2t").textContent=fmt(Math.round(ww*TILE_WORK.price));
}
function toggleW(i){const w=S.works[i];if(w.group&&!w.enabled)S.works.forEach(x=>{if(x.group===w.group)x.enabled=false;});w.enabled=!w.enabled;saveState();renderWC();renderMC();}

function updWorkPrice(i){
  const prInp=$("workPr"+i),ttInp=$("workTt"+i);
  const price=Math.round(parseFloat(prInp&&prInp.value)||0);
  const title=(ttInp&&ttInp.value||"").trim();
  if(!price&&!title)return;
  if(price>0)S.works[i].price=price;
  if(title)S.works[i].title=title;
  if(!S.works[i].enabled)S.works[i].enabled=true;
  saveState();
  if(prInp)prInp.value="";if(ttInp)ttInp.value="";
  renderWC();renderMC();
}

let weIdx=-1;
function openWorkEd(i){weIdx=i;const w=i>=0?S.works[i]:null;$("weTitle").textContent=w?"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å":"–ù–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞";$("weN").value=w?w.name:"";$("weP").value=w?w.price:"";$("weU").value=w?w.unit:"–º¬≤";$("weT").value=w?w.type:"area";$("weQ").value=w?w.qty||"":"";$("weDed").checked=w?!!w.deduct:false;$("weDedV").value=w?w.deduct||1:1;weUpd();$("weMo").classList.add("open");}
function closeWorkEd(){$("weMo").classList.remove("open");weIdx=-1;}
function weUpd(){$("weQL").style.display=$("weT").value==="manual"?"block":"none";$("weDedV").style.display=$("weDed").checked?"block":"none";}
function saveWorkEd(){const n=$("weN").value.trim();if(!n)return;const o={id:weIdx>=0?S.works[weIdx].id:"custom_"+Date.now(),name:n,price:parseFloat($("weP").value)||0,unit:$("weU").value.trim()||"—à—Ç",type:$("weT").value,qty:parseFloat($("weQ").value)||0,enabled:weIdx>=0?S.works[weIdx].enabled:true};if(weIdx>=0&&S.works[weIdx].group)o.group=S.works[weIdx].group;if($("weDed").checked)o.deduct=parseFloat($("weDedV").value)||0;if(weIdx>=0)S.works[weIdx]=o;else S.works.push(o);saveState();renderWC();renderMC();closeWorkEd();}

// ‚ïê‚ïê‚ïê MATERIAL CARDS (simplified) ‚ïê‚ïê‚ïê
let showAllMats=false;
let showMatList=false;
let matSortOrder=null; // cached sort order

function buildMatOrder(ei){
  // Build sorted order: active first, inactive last, stable within groups
  const active=[],inactive=[];
  S.materials.forEach((m,i)=>{
    const condMet=!m.cond||ei.has(m.cond);
    const manualOn=!!m.manualOn;
    const isActive=m.enabled&&(condMet||manualOn);
    if(isActive)active.push(i); else inactive.push(i);
  });
  return active.concat(inactive);
}

function renderMC(){
  const a=calcW(),ei=eIds();

  // Count active materials and total cost for summary
  let matSummaryCount=0,matSummaryTotal=0;
  S.materials.forEach(m=>{
    if(!m.enabled)return;
    const condMet=!m.cond||ei.has(m.cond);
    if(!condMet&&!m.manualOn)return;
    const p=matPrice(m),q=matQty(m,a);if(q<=0)return;
    matSummaryCount++;matSummaryTotal+=Math.round(q*p);
  });

  let h='<div style="margin-bottom:8px;font-weight:700;font-size:15px;display:flex;justify-content:space-between;align-items:center">';
  if(matSummaryCount>0)h+=`<span style="font-size:13px;font-weight:600;color:var(--ok)">${matSummaryCount} –ø–æ–∑. ¬∑ ${matSummaryTotal>0?fmt(matSummaryTotal)+' –≥—Ä–Ω':'—Ü–µ–Ω—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã'}</span>`;
  h+=`</div>`;

  const mArrow=showMatList?"‚ñ≤":"‚ñº";
  h+=`<button class="bt bt2" style="padding:14px;font-size:15px;font-weight:800;border:2px solid var(--ok);color:var(--ok);background:rgba(16,185,129,.08)" onclick="showMatList=!showMatList;if(showMatList)matSortOrder=buildMatOrder(eIds());else matSortOrder=null;renderMC()">üì¶ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ${mArrow}</button>`;

  if(!showMatList){
    $("matCards").innerHTML=h;
    return;
  }

  // If no cached order, build it
  if(!matSortOrder)matSortOrder=buildMatOrder(ei);

  function renderCard(m,i){
    const condMet=!m.cond||ei.has(m.cond);
    const manualOn=!!m.manualOn;
    const active=m.enabled&&(condMet||manualOn);
    const p=matPrice(m),q=matQty(m,a),s=active&&q>0?Math.round(q*p):0;
    const linksWithPrice=(m.links||[]).filter(l=>l.price>0);
    const hasL=linksWithPrice.length>0;
    const isCustom=!BASE_MATS.find(b=>b.id===m.id);
    let c=`<div class="mi${active?" on":""}">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="ck" style="cursor:pointer" onclick="tgMatSmart(${i})">${active?"‚úì":""}</div>
        <div style="flex:1;min-width:0;cursor:pointer" onclick="tgMatSmart(${i})">
          <div style="font-weight:600;font-size:13px">${esc(m.name)}</div>
          <div style="font-size:11px;color:var(--dim);margin-top:2px">${(hasL?'<span style="color:var(--ok)">‚óè</span> ':'')+(p>0?p+' –≥—Ä–Ω/'+esc(m.unit):'—Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞')+(active&&q>0?' ¬∑ <b>'+q+' '+esc(m.unit)+'</b>'+(s>0?' = '+fmt(s)+' –≥—Ä–Ω':''):'')}</div>
        </div>
        ${isCustom?`<button onclick="S.materials.splice(${i},1);saveState();renderMC()" style="background:none;border:none;cursor:pointer;font-size:13px;padding:4px;color:var(--err)">‚úï</button>`:""}
      </div>`;
    if(m.links&&m.links.length>0){
      c+=`<div class="ml">`;
      m.links.forEach(function(l,li){
        const host=l.url?hostName(l.url):"";const ps=l.price?l.price+" –≥—Ä–Ω":"‚Äî";const age=priceAge(l.updated);const tt=l.title||"";
        c+=`<div class="ml-r">${l.url?`<a href="${esc(l.url)}" target="_blank">üîó ${tt?esc(tt):esc(host)}</a>`:`<span style="color:var(--dim)">${tt?'üí∞ '+esc(tt):'üí∞ –≤—Ä—É—á–Ω—É—é'}</span>`}<span class="price-badge ${age.cls}">${age.text}</span><span class="p">${ps}</span>${l.history&&l.history.length>0?`<span class="old">${l.history[l.history.length-1].price}</span>`:""}<button class="ed" onclick="openLinkEd(${i},${li})" title="–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É">‚úèÔ∏è</button><button class="x" onclick="rmLink(${i},${li})">‚úï</button></div>`;
      });
      c+=`</div>`;
    }
    c+=`<div class="ml-add"><input id="linkTt${i}" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"><div class="ml-row"><input id="linkInp${i}" placeholder="—Å—Å—ã–ª–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç.)" style="flex:1" onkeydown="if(event.key==='Enter'){event.preventDefault();addLink(${i})}"><input id="linkPr${i}" type="number" placeholder="–≥—Ä–Ω" style="width:65px;text-align:center" onkeydown="if(event.key==='Enter'){event.preventDefault();addLink(${i})}"><button type="button" onclick="addLink(${i})">+</button></div></div>`;
    c+=`</div>`;
    return c;
  }

  // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
  matSortOrder.forEach(i=>{
    h+=renderCard(S.materials[i],i);
  });

  h+=`<button class="bt bt2" style="padding:12px;font-size:14px;margin-top:4px" onclick="openMatEd(-1)">+ –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>`;
  h+=`<button class="bt bt2" style="padding:12px;font-size:14px;margin-top:4px" onclick="showMatList=false;matSortOrder=null;renderMC()">‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã</button>`;
  $("matCards").innerHTML=h;
}

function tgMatSmart(i){
  const m=S.materials[i];
  const ei=eIds();
  const condMet=!m.cond||ei.has(m.cond);
  if(condMet){
    // –†–∞–±–æ—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ ‚Äî –æ–±—ã—á–Ω—ã–π toggle
    m.enabled=!m.enabled;
    m.manualOn=false;
  }else{
    // –†–∞–±–æ—Ç–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞, –Ω–æ –µ—Å—Ç—å –ø—Ä–∏–≤—è–∑–∫–∞ ‚Äî —Ä—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ
    if(m.manualOn){m.manualOn=false;}
    else{m.manualOn=true;m.enabled=true;}
  }
  saveState();renderMC();
}
function rmLink(mi,li){S.materials[mi].links.splice(li,1);saveState();renderMC();updateDbPanel();}

function addLink(mi){
  const inp=$("linkInp"+mi),prInp=$("linkPr"+mi),ttInp=$("linkTt"+mi);
  let url=(inp&&inp.value||"").trim();
  const price=Math.round(parseFloat(prInp&&prInp.value)||0);
  const title=(ttInp&&ttInp.value||"").trim();
  if(!url&&!price&&!title)return;
  if(!price){alert("–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É");return;}
  if(url&&!url.startsWith("http"))url="https://"+url;
  S.materials[mi].links.push({url:url||"",price,updated:now(),note:"",title:title,history:[]});
  // Save price and title directly to material
  S.materials[mi].price=price;
  if(title)S.materials[mi].productTitle=title;
  saveState();
  if(inp)inp.value="";if(prInp)prInp.value="";if(ttInp)ttInp.value="";
  renderMC();updateDbPanel();
}

// ‚ïê‚ïê‚ïê LINK EDIT MODAL ‚ïê‚ïê‚ïê
let leMatIdx=-1,leLinkIdx=-1;
function openLinkEd(mi,li){
  leMatIdx=mi;leLinkIdx=li;
  const l=S.materials[mi].links[li];
  $("leUrl").value=l.url;
  $("lePrice").value=l.price||"";
  $("leNote").value=l.note||"";
  $("leTitle").value=l.title||"";
  $("leMo").classList.add("open");
}
function closeLinkEd(){$("leMo").classList.remove("open");}
function saveLinkEd(){
  if(leMatIdx<0||leLinkIdx<0)return;
  const l=S.materials[leMatIdx].links[leLinkIdx];
  const newPrice=Math.round(parseFloat($("lePrice").value)||0);
  if(newPrice>0&&l.price>0&&newPrice!==l.price){
    if(!l.history)l.history=[];
    l.history.push({price:l.price,date:now()});
    if(l.history.length>10)l.history.shift();
  }
  l.url=$("leUrl").value.trim()||l.url;
  l.price=newPrice;
  l.note=$("leNote").value.trim();
  l.title=$("leTitle").value.trim();
  l.updated=now();
  // Sync price and title to material
  if(newPrice>0)S.materials[leMatIdx].price=newPrice;
  if(l.title)S.materials[leMatIdx].productTitle=l.title;
  saveState();
  closeLinkEd();
  renderMC();updateDbPanel();
  if($("s3").classList.contains("on"))renderResult();
}

// ‚ïê‚ïê‚ïê MAT ADD MODAL (only for new materials) ‚ïê‚ïê‚ïê
let meIdx=-1;
function openMatEd(i){
  if(i>=0)return; // no editing existing ‚Äî only add new
  meIdx=-1;
  $("meTitle").textContent="–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª";
  $("meN").value="";$("meP").value="";$("meU").value="—à—Ç";
  $("meR").value="";$("meFQ").value="";
  $("meMo").classList.add("open");
}
function closeMatEd(){$("meMo").classList.remove("open");meIdx=-1;}
function saveMatEd(){
  const n=$("meN").value.trim();if(!n)return;
  const o={id:"custom_"+Date.now(),name:n,price:parseFloat($("meP").value)||0,unit:$("meU").value.trim()||"—à—Ç",rate:parseFloat($("meR").value)||0,enabled:true,links:[]};
  const fq=parseInt($("meFQ").value)||0;if(fq>0)o.fixedQty=fq;
  S.materials.push(o);
  saveState();closeMatEd();renderMC();updateDbPanel();
  if($("s3").classList.contains("on"))renderResult();
}

// ‚ïê‚ïê‚ïê DB PANEL ‚ïê‚ïê‚ïê
let dbOpen=false;
function toggleDbPanel(){/* removed */}

function updateDbPanel(){/* panel removed */}

function refreshAllPrices(){
  const urls=[];
  S.materials.forEach(m=>(m.links||[]).forEach(l=>{if(l.url)urls.push(l.url);}));
  if(!urls.length){alert("–ù–µ—Ç —Å—Å—ã–ª–æ–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");return;}
  if(confirm(`–û—Ç–∫—Ä—ã—Ç—å ${urls.length} —Å—Å—ã–ª–æ–∫ –≤ –Ω–æ–≤—ã—Ö –≤–∫–ª–∞–¥–∫–∞—Ö?\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ü–µ–Ω—ã –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ,\n–∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ ‚úèÔ∏è`)){
    urls.forEach(u=>window.open(u,"_blank"));
  }
}

function openAllLinksForRefresh(){
  const urls=[];
  S.materials.forEach(m=>(m.links||[]).forEach(l=>{if(l.url)urls.push(l.url);}));
  if(!urls.length){alert("–ù–µ—Ç —Å—Å—ã–ª–æ–∫");return;}
  if(confirm(`–û—Ç–∫—Ä—ã—Ç—å ${urls.length} —Å—Å—ã–ª–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–Ω?`)){
    urls.forEach(u=>window.open(u,"_blank"));
  }
}

function exportDb(){
  const data={version:2,exported:new Date().toISOString(),materials:S.materials.map(m=>({id:m.id,name:m.name,price:m.price,unit:m.unit,rate:m.rate,links:m.links||[],fixedQty:m.fixedQty,cond:m.cond}))};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="tilecalc_db_"+new Date().toISOString().slice(0,10)+".json";
  a.click();URL.revokeObjectURL(a.href);
}

function importDb(event){
  const f=event.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const data=JSON.parse(e.target.result);
      if(!data.materials||!Array.isArray(data.materials)){alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞");return;}
      if(!confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${data.materials.length} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤?\n\n–°—Å—ã–ª–∫–∏ –±—É–¥—É—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã —Å —Ç–µ–∫—É—â–∏–º–∏.`))return;

      data.materials.forEach(imp=>{
        const existing=S.materials.find(m=>m.id===imp.id);
        if(existing){
          // Merge links
          (imp.links||[]).forEach(il=>{
            const dup=existing.links.find(el=>el.url===il.url);
            if(!dup){
              existing.links.push({url:il.url,price:il.price,updated:il.updated||now(),note:il.note||"",history:il.history||[]});
            }else if(il.price&&il.updated>dup.updated){
              if(dup.price!==il.price){
                if(!dup.history)dup.history=[];
                dup.history.push({price:dup.price,date:now()});
              }
              dup.price=il.price;dup.updated=il.updated;
            }
          });
          if(imp.price)existing.price=imp.price;
        }else{
          // Add new material
          S.materials.push({
            id:imp.id||"imp_"+Date.now()+"_"+Math.random().toString(36).slice(2,6),
            name:imp.name,price:imp.price||0,unit:imp.unit||"—à—Ç",
            rate:imp.rate||0,enabled:true,
            links:(imp.links||[]).map(l=>({url:l.url,price:l.price||0,updated:l.updated||now(),note:l.note||"",history:l.history||[]})),
            fixedQty:imp.fixedQty,cond:imp.cond
          });
        }
      });
      saveState();renderMC();updateDbPanel();
      alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!");
    }catch(err){alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: "+err.message);}
  };
  reader.readAsText(f);
  event.target.value="";
}

function clearAllLinks(){
  const t=totalLinks();
  if(!t.count){alert("–ù–µ—Ç —Å—Å—ã–ª–æ–∫");return;}
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${t.count} —Å—Å—ã–ª–æ–∫? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`))return;
  S.materials.forEach(m=>m.links=[]);
  saveState();renderMC();updateDbPanel();
}

// ‚ïê‚ïê‚ïê RESULT ‚ïê‚ïê‚ïê
function renderResult(){
  const wk=calcW(),{l,w}=gv();
  const wl=[{n:TILE_WORK.name,q:wk,u:TILE_WORK.unit,p:TILE_WORK.price,s:Math.round(wk*TILE_WORK.price),t:"",idx:-1}];
  S.works.forEach((w,i)=>{if(!w.enabled)return;const q=wQty(w,wk);if(q<=0&&w.type!=="fixed")return;wl.push({n:w.name,q,u:w.unit,p:w.price,s:Math.round(q*w.price),t:w.title||"",idx:i});});
  const wt=wl.reduce((a,x)=>a+x.s,0);

  let wh="";
  wl.forEach((x,idx)=>{
    const even=idx%2===0;
    wh+=`<div style="display:flex;align-items:center;padding:10px 16px;${even?'background:rgba(245,158,11,.04);':''}border-radius:8px;margin-bottom:2px">
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:14px">${esc(x.n)}</div>
        <div style="font-size:11px;color:var(--dim);margin-top:2px">${x.t?'<span style="color:var(--accent);font-weight:600">'+esc(x.t)+'</span> ¬∑ ':''}<span>${x.q} ${esc(x.u)} √ó ${fmt(x.p)} –≥—Ä–Ω</span></div>
      </div>
      <div style="font-weight:800;font-size:15px;white-space:nowrap;margin-left:12px">${fmt(x.s)} –≥—Ä–Ω</div>
      ${x.idx>=0?'<button onclick="removeWorkResult('+x.idx+')" style="background:none;border:none;cursor:pointer;font-size:13px;padding:4px 8px;color:var(--err);margin-left:6px">‚úï</button>':''}
    </div>`;
  });
  $("wRows").innerHTML=wh;$("whTotal").textContent=fmt(wt)+" –≥—Ä–Ω";

  const ei=eIds(),ml=[];
  S.materials.forEach((m,i)=>{
    if(!m.enabled)return;
    const condMet=!m.cond||ei.has(m.cond);
    if(!condMet&&!m.manualOn)return;
    const p=matPrice(m),q=matQty(m,wk);if(q<=0)return;
    const best=matBest(m);
    const linksWithPrice=(m.links||[]).filter(l=>l.price>0);
    ml.push({name:m.name,qty:q,unit:m.unit,price:p,sum:Math.round(q*p),best,links:m.links||[],hasL:linksWithPrice.length>0,linksWithPrice,idx:i,productTitle:m.productTitle||""});
  });

  const mt=ml.reduce((a,x)=>a+x.sum,0);

  let mh="";
  ml.forEach((x,idx)=>{
    const title=x.productTitle||(x.best?(x.best.title||x.best.note||""):(x.linksWithPrice.length>0?(x.linksWithPrice[0].title||x.linksWithPrice[0].note||""):""));
    const even=idx%2===0;
    mh+=`<div style="display:flex;align-items:center;padding:10px 16px;${even?'background:rgba(16,185,129,.04);':''}border-radius:8px;margin-bottom:2px">
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;font-size:14px">${esc(x.name)}</div>
        <div style="font-size:11px;color:var(--dim);margin-top:2px">${title?'<span style="color:var(--ok);font-weight:600">'+esc(title)+'</span> ¬∑ ':''}<span>${x.qty} ${esc(x.unit)} √ó ${fmt(x.price)} –≥—Ä–Ω</span></div>
      </div>
      <div style="font-weight:800;font-size:15px;white-space:nowrap;margin-left:12px">${fmt(x.sum)} –≥—Ä–Ω</div>
      <button onclick="removeMatResult(${x.idx})" style="background:none;border:none;cursor:pointer;font-size:13px;padding:4px 8px;color:var(--err);margin-left:6px">‚úï</button>
    </div>`;
  });

  if(!ml.length)mh=`<div style="text-align:center;color:var(--dim);padding:20px">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>`;
  $("mRows").innerHTML=mh;$("mhTotal").textContent=fmt(mt)+" –≥—Ä–Ω";
  $("tWork").textContent=fmt(wt)+" –≥—Ä–Ω";$("tMat").textContent=fmt(mt)+" –≥—Ä–Ω";

  $("infoBar").textContent=`–ü–ª–æ—â–∞–¥—å: ${wk} –º¬≤ ¬∑ ${l}√ó${w} –º ¬∑ H=${H} –º`;
}

function removeWorkResult(i){S.works[i].enabled=false;saveState();renderResult();}
function removeMatResult(i){S.materials[i].enabled=false;S.materials[i].manualOn=false;saveState();renderResult();}

function toggleSec(id,hdr){const el=$(id),o=el.style.display!=="none";el.style.display=o?"none":"block";const h=hdr.querySelector("span span");if(h)h.textContent=o?"‚ñ∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ":"‚ñæ —Å–≤–µ—Ä–Ω—É—Ç—å";}

// ‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê
function buildEstimateText(){
  const wk=calcW(),{l,w}=gv();
  const ei=eIds();
  let txt=`–°–ú–ï–¢–ê ‚Äî –ü–ª–∏—Ç–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\n`;
  txt+=`${"‚ïê".repeat(35)}\n`;
  txt+=`–ü–ª–æ—â–∞–¥—å: ${wk} –º¬≤ (${l}√ó${w} –º, H=${H} –º)\n\n`;

  // –†–∞–±–æ—Ç—ã
  txt+=`üîß –†–ê–ë–û–¢–´\n${"‚îÄ".repeat(35)}\n`;
  const wl=[{n:TILE_WORK.name,q:wk,u:TILE_WORK.unit,p:TILE_WORK.price,s:Math.round(wk*TILE_WORK.price)}];
  S.works.forEach(ww=>{if(!ww.enabled)return;const q=wQty(ww,wk);if(q<=0&&ww.type!=="fixed")return;wl.push({n:ww.name,q,u:ww.unit,p:ww.price,s:Math.round(q*ww.price)});});
  wl.forEach(x=>{txt+=`${x.n}: ${x.q} ${x.u} √ó ${x.p} –≥—Ä–Ω = ${fmt(x.s)} –≥—Ä–Ω\n`;});
  const wt=wl.reduce((a,x)=>a+x.s,0);
  txt+=`\n–ò—Ç–æ–≥–æ —Ä–∞–±–æ—Ç–∞: ${fmt(wt)} –≥—Ä–Ω\n\n`;

  // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
  txt+=`üì¶ –ú–ê–¢–ï–†–ò–ê–õ–´\n${"‚îÄ".repeat(35)}\n`;
  const ml=[];
  S.materials.forEach(m=>{
    if(!m.enabled)return;
    const condMet=!m.cond||ei.has(m.cond);
    if(!condMet&&!m.manualOn)return;
    const p=matPrice(m),q=matQty(m,wk);if(q<=0)return;
    ml.push({name:m.name,qty:q,unit:m.unit,price:p,sum:Math.round(q*p)});
  });
  ml.forEach(x=>{txt+=`${x.name}: ${x.qty} ${x.unit} √ó ${x.price} –≥—Ä–Ω = ${fmt(x.sum)} –≥—Ä–Ω\n`;});
  const mt=ml.reduce((a,x)=>a+x.sum,0);
  txt+=`\n–ò—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: ${fmt(mt)} –≥—Ä–Ω\n`;
  txt+=`\n${"‚ïê".repeat(35)}\n`;
  txt+=`–û–ë–©–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨: ${fmt(wt+mt)} –≥—Ä–Ω\n`;
  txt+=`(—Ä–∞–±–æ—Ç–∞: ${fmt(wt)} + –º–∞—Ç–µ—Ä–∏–∞–ª—ã: ${fmt(mt)})\n`;
  txt+=`${"‚ïê".repeat(35)}\n`;
  txt+=`\n–î–∞—Ç–∞: ${new Date().toLocaleDateString("uk-UA")}\n`;
  return txt;
}

function exportPDF(mode){
  mode=mode||"all";
  const wk=calcW(),{l,w}=gv(),ei=eIds();

  let html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>–°–º–µ—Ç–∞</title>
<style>body{font-family:Arial,sans-serif;padding:40px;color:#222;font-size:14px;max-width:700px;margin:0 auto}
h1{font-size:22px;border-bottom:2px solid #f59e0b;padding-bottom:8px;margin-bottom:5px}
.sub{color:#666;font-size:12px;margin-bottom:20px}
table{width:100%;border-collapse:collapse;margin-bottom:20px}
th{background:#f59e0b;color:#fff;padding:8px 10px;text-align:left;font-size:12px}
td{padding:7px 10px;border-bottom:1px solid #eee;font-size:13px}
.total-row td{font-weight:700;border-top:2px solid #333;font-size:14px}
.grand{background:#fffbeb;border:2px solid #f59e0b;border-radius:10px;padding:16px 20px;text-align:center;margin:20px 0}
.grand b{font-size:28px;color:#d97706}
.footer{color:#999;font-size:11px;margin-top:30px;border-top:1px solid #eee;padding-top:10px}
@media print{body{padding:20px}}</style></head><body>
<h1>–°–º–µ—Ç–∞ ‚Äî –ü–ª–∏—Ç–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h1>
<div class="sub">–ü–ª–æ—â–∞–¥—å: ${wk} –º¬≤ ¬∑ ${l}√ó${w} –º ¬∑ H=${H} –º ¬∑ ${new Date().toLocaleDateString("uk-UA")}</div>`;

  let wt=0,mt=0;
  if(mode==="all"||mode==="works"){
    html+=`<h3>–†–∞–±–æ—Ç—ã</h3><table><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th></tr>`;
    const wl=[{n:TILE_WORK.name,q:wk,u:TILE_WORK.unit,p:TILE_WORK.price,s:Math.round(wk*TILE_WORK.price)}];
    S.works.forEach(ww=>{if(!ww.enabled)return;const q=wQty(ww,wk);if(q<=0&&ww.type!=="fixed")return;wl.push({n:ww.name,q,u:ww.unit,p:ww.price,s:Math.round(q*ww.price)});});
    wl.forEach(x=>{html+=`<tr><td>${esc(x.n)}</td><td>${x.q} ${esc(x.u)}</td><td>${fmt(x.p)} –≥—Ä–Ω</td><td>${fmt(x.s)} –≥—Ä–Ω</td></tr>`;});
    wt=wl.reduce((a,x)=>a+x.s,0);
    html+=`<tr class="total-row"><td colspan="3">–ò—Ç–æ–≥–æ —Ä–∞–±–æ—Ç–∞</td><td>${fmt(wt)} –≥—Ä–Ω</td></tr></table>`;
  }
  if(mode==="all"||mode==="mats"){
    html+=`<h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h3><table><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th></tr>`;
    const ml=[];
    S.materials.forEach(m=>{
      if(!m.enabled)return;const condMet=!m.cond||ei.has(m.cond);
      if(!condMet&&!m.manualOn)return;
      const p=matPrice(m),q=matQty(m,wk);if(q<=0)return;
      ml.push({name:m.name,qty:q,unit:m.unit,price:p,sum:Math.round(q*p),pt:m.productTitle||""});
    });
    ml.forEach(x=>{html+=`<tr><td>${esc(x.name)}${x.pt?' <span style="color:#059669;font-size:11px">'+esc(x.pt)+'</span>':''}</td><td>${x.qty} ${esc(x.unit)}</td><td>${fmt(x.price)} –≥—Ä–Ω</td><td>${fmt(x.sum)} –≥—Ä–Ω</td></tr>`;});
    mt=ml.reduce((a,x)=>a+x.sum,0);
    html+=`<tr class="total-row"><td colspan="3">–ò—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</td><td>${fmt(mt)} –≥—Ä–Ω</td></tr></table>`;
  }
  const gt=mode==="works"?wt:mode==="mats"?mt:wt+mt;
  html+=`<div class="grand">${mode==="works"?"–°–¢–û–ò–ú–û–°–¢–¨ –†–ê–ë–û–¢":mode==="mats"?"–°–¢–û–ò–ú–û–°–¢–¨ –ú–ê–¢–ï–†–ò–ê–õ–û–í":"–û–ë–©–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨"}<br><b>${fmt(gt)} –≥—Ä–Ω</b>`;
  if(mode==="all")html+=`<br><span style="font-size:13px;color:#666">—Ä–∞–±–æ—Ç–∞: ${fmt(wt)} + –º–∞—Ç–µ—Ä–∏–∞–ª—ã: ${fmt(mt)}</span>`;
  html+=`</div><div class="footer">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString("uk-UA")}</div></body></html>`;

  const sfx=mode==="works"?"_raboty":mode==="mats"?"_materialy":"";
  const blob=new Blob([html],{type:"text/html;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="smeta"+sfx+"_"+new Date().toISOString().slice(0,10)+".html";
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function shareTxt(){
  const txt=buildEstimateText();
  if(navigator.share){
    navigator.share({title:"–°–º–µ—Ç–∞ ‚Äî –ø–ª–∏—Ç–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã",text:txt}).catch(()=>{});
  }else if(navigator.clipboard){
    navigator.clipboard.writeText(txt).then(()=>{alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!")}).catch(()=>fallbackCopy(txt));
  }else{fallbackCopy(txt);}
}
function fallbackCopy(txt){
  const ta=document.createElement("textarea");ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta);alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
}

// ‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê
function getHistory(){try{return JSON.parse(localStorage.getItem("tilecalc_history")||"[]");}catch(e){return[];}}
function setHistory(h){try{localStorage.setItem("tilecalc_history",JSON.stringify(h));}catch(e){}}

function saveToHistory(){
  const wk=calcW(),{l,w}=gv(),ei=eIds();
  const wl=[{n:TILE_WORK.name,q:wk,u:TILE_WORK.unit,p:TILE_WORK.price,s:Math.round(wk*TILE_WORK.price)}];
  S.works.forEach(ww=>{if(!ww.enabled)return;const q=wQty(ww,wk);if(q<=0&&ww.type!=="fixed")return;wl.push({n:ww.name,q,u:ww.unit,p:ww.price,s:Math.round(q*ww.price)});});
  const wt=wl.reduce((a,x)=>a+x.s,0);
  const ml=[];
  S.materials.forEach(m=>{if(!m.enabled)return;const condMet=!m.cond||ei.has(m.cond);if(!condMet&&!m.manualOn)return;const p=matPrice(m),q=matQty(m,wk);if(q<=0)return;ml.push({name:m.name,qty:q,unit:m.unit,price:p,sum:Math.round(q*p)});});
  const mt=ml.reduce((a,x)=>a+x.sum,0);

  const name=prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ—Ç—ã:",`${l}√ó${w} –º ‚Äî ${new Date().toLocaleDateString("uk-UA")}`);
  if(!name)return;

  const entry={
    id:Date.now(),
    name:name,
    date:new Date().toISOString(),
    dims:{l,w,d:parseFloat($("iD").value)||0},
    area:wk,
    workTotal:wt,
    matTotal:mt,
    grandTotal:wt+mt,
    state:JSON.parse(JSON.stringify(S)),
    inputL:$("iL").value,
    inputW:$("iW").value,
    inputD:$("iD").value
  };

  const hist=getHistory();
  hist.unshift(entry);
  if(hist.length>20)hist.pop();
  setHistory(hist);
  alert("–°–º–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
}

function renderHistory(){
  const hist=getHistory();
  if(!hist.length){$("historyList").innerHTML="";return;}
  let h='<div style="margin-top:4px;margin-bottom:8px;font-weight:700;font-size:15px;display:flex;justify-content:space-between;align-items:center"><span>üìã –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ—Ç</span><button onclick="clearHistory()" style="background:none;border:none;color:var(--dim);font-size:11px;cursor:pointer;font-family:inherit">–æ—á–∏—Å—Ç–∏—Ç—å</button></div>';
  hist.forEach((e,i)=>{
    const d=new Date(e.date);
    const dateStr=d.toLocaleDateString("uk-UA")+" "+d.toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"});
    h+=`<div class="hi-card">
      <div class="hi-title">${esc(e.name)}</div>
      <div class="hi-sub">${dateStr} ¬∑ ${e.area} –º¬≤ ¬∑ —Ä–∞–±–æ—Ç–∞: ${fmt(e.workTotal)} + –º–∞—Ç: ${fmt(e.matTotal)}</div>
      <div class="hi-price">${fmt(e.grandTotal)} –≥—Ä–Ω</div>
      <div class="hi-actions">
        <button onclick="event.stopPropagation();loadHistory(${i})">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <button onclick="event.stopPropagation();duplicateHistory(${i})">üìã –ö–æ–ø–∏—è</button>
        <button onclick="event.stopPropagation();renameHistory(${i})">‚úèÔ∏è –ò–º—è</button>
        <button class="del" onclick="event.stopPropagation();deleteHistory(${i})">‚úï</button>
      </div>
    </div>`;
  });
  $("historyList").innerHTML=h;
}

function loadHistory(i){
  const hist=getHistory();
  const e=hist[i];if(!e)return;
  S=JSON.parse(JSON.stringify(e.state));
  saveState();
  $("iL").value=e.inputL||e.dims.l;
  $("iW").value=e.inputW||e.dims.w;
  $("iD").value=e.inputD||e.dims.d;
  updGeo();
  go(2);
}

function duplicateHistory(i){
  const hist=getHistory();
  const e=JSON.parse(JSON.stringify(hist[i]));if(!e)return;
  e.id=Date.now();
  e.name=e.name+" (–∫–æ–ø–∏—è)";
  e.date=new Date().toISOString();
  hist.splice(i+1,0,e);
  setHistory(hist);
  renderHistory();
}

function renameHistory(i){
  const hist=getHistory();
  const name=prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:",hist[i].name);
  if(!name)return;
  hist[i].name=name;
  setHistory(hist);
  renderHistory();
}

function deleteHistory(i){
  const hist=getHistory();
  hist.splice(i,1);
  setHistory(hist);
  renderHistory();
}

function clearHistory(){
  const hist=getHistory();
  if(!hist.length)return;
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é ("+hist.length+" –∑–∞–ø–∏—Å–µ–π)?"))return;
  setHistory([]);
  renderHistory();
}

// ‚ïê‚ïê‚ïê SYNC ‚ïê‚ïê‚ïê
function exportAllData(){
  var data={
    state:S,
    history:getHistory(),
    dims:{l:$("iL").value,w:$("iW").value,d:$("iD").value},
    tilePrice:TILE_WORK.price,
    ceilingH:H,
    version:"tilecalc_export_v2",
    date:new Date().toISOString()
  };
  var blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  var a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="tilecalc_data_"+new Date().toISOString().slice(0,10)+".json";
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function importAllData(event){
  var f=event.target.files[0];if(!f)return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var data=JSON.parse(e.target.result);
      if(data.state&&data.state.materials){
        S=data.state;
        if(data.tilePrice)TILE_WORK.price=data.tilePrice;
        if(data.ceilingH)H=data.ceilingH;
        S._tilePrice=TILE_WORK.price;
        S._H=H;
        saveState();
        if(data.history){setHistory(data.history);}
        if(data.dims){
          $("iL").value=data.dims.l||"";
          $("iW").value=data.dims.w||"";
          $("iD").value=data.dims.d||"0";
        }
        updGeo();renderHistory();
        alert("–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!");
      }else{
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞");
      }
    }catch(err){alert("–û—à–∏–±–∫–∞: "+err.message);}
  };
  reader.readAsText(f);
  event.target.value="";
}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
function openSettings(){
  document.querySelectorAll(".scr").forEach(function(s){s.classList.remove("on")});
  $("s4").classList.add("on");
  window.scrollTo(0,0);
  $("setTilePrice").value=TILE_WORK.price;
  $("setH").value=H;
  // Render work prices
  var wh="";
  S.works.forEach(function(w,i){
    wh+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;padding:6px 0;border-bottom:1px solid var(--border)">'+
      '<span style="font-size:12px;flex:1;min-width:0">'+esc(w.name)+'</span>'+
      '<input class="inp-s" type="number" id="setW'+i+'" value="'+w.price+'" style="width:70px;font-size:13px;text-align:center">'+
      '<span style="font-size:11px;color:var(--dim);width:40px">'+esc(w.unit)+'</span></div>';
  });
  $("setWorksList").innerHTML=wh;
  // Render material prices
  var mh="";
  S.materials.forEach(function(m,i){
    mh+='<div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;padding:6px 0;border-bottom:1px solid var(--border)">'+
      '<span style="font-size:12px;flex:1;min-width:0">'+esc(m.name)+'</span>'+
      '<input class="inp-s" type="number" id="setMp'+i+'" value="'+(m.price||0)+'" style="width:65px;font-size:13px;text-align:center" placeholder="–≥—Ä–Ω">'+
      '<input class="inp-s" type="text" id="setMt'+i+'" value="'+esc(m.productTitle||"")+'" style="width:90px;font-size:11px" placeholder="—Ç–æ–≤–∞—Ä"></div>';
  });
  $("setMatsList").innerHTML=mh;
}
function saveSettings(){
  // Save tile price and height (runtime override)
  TILE_WORK.price=parseFloat($("setTilePrice").value)||TILE_WORK.price;
  H=parseFloat($("setH").value)||H;
  // Save work prices
  S.works.forEach(function(w,i){
    var inp=$("setW"+i);
    if(inp)w.price=parseFloat(inp.value)||w.price;
  });
  // Save material prices and titles
  S.materials.forEach(function(m,i){
    var pInp=$("setMp"+i);
    var tInp=$("setMt"+i);
    if(pInp){var p=parseFloat(pInp.value)||0;if(p>0)m.price=p;}
    if(tInp){var t=tInp.value.trim();if(t)m.productTitle=t;}
  });
  // Persist tile price and H in state
  S._tilePrice=TILE_WORK.price;
  S._H=H;
  saveState();
  alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
  closeSettings();
}
function closeSettings(){
  document.querySelectorAll(".scr").forEach(function(s){s.classList.remove("on")});
  $("s3").classList.add("on");
  window.scrollTo(0,0);
  renderResult();
}

function resetAll(){S=defaultState();saveState();$("iL").value="";$("iW").value="";$("iD").value="0";updGeo();go(1);}

// Reset session state on fresh app open (not swipe-resume)
function resetSessionState(){
  // Reset work enabled flags to defaults
  S.works.forEach(function(w){
    var base=BASE_WORKS.find(function(b){return b.id===w.id;});
    w.enabled=base?base.enabled:false;
    // Reset manual qty overrides
    if(w.manualQty!==undefined)delete w.manualQty;
  });
  // Reset material enabled/manualOn to defaults
  S.materials.forEach(function(m){
    var base=BASE_MATS.find(function(b){return b.id===m.id;});
    m.enabled=base?base.enabled:true;
    m.manualOn=false;
  });
  saveState();
}

loadState();

// Session check: if no sessionStorage flag ‚Üí fresh open ‚Üí reset work state
if(!sessionStorage.getItem("tilecalc_session")){
  sessionStorage.setItem("tilecalc_session","1");
  resetSessionState();
  // Clear dimensions
  $("iL").value="";$("iW").value="";$("iD").value="0";
}

// Back button: navigate steps instead of closing app
var curStep=1;
var _origGo=go;
go=function(n){curStep=n;history.pushState({step:n},"","");_origGo(n);};
window.addEventListener("popstate",function(e){
  if(e.state&&e.state.step){curStep=e.state.step;_origGo(curStep);}
  else if(curStep>1){curStep--;history.pushState({step:curStep},"","");_origGo(curStep);}
  else{history.pushState({step:1},"","");}
});
history.replaceState({step:1},"","");

$("iL").addEventListener("input",updGeo);$("iW").addEventListener("input",updGeo);$("iD").addEventListener("input",updGeo);updGeo();renderHistory();
</script>
</body>
</html>
